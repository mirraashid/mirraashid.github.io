<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <style>
        .input-w-ph-c {
            position: relative;
        }

        .append-placeholder {
            position: absolute;
            top: 7px;
            left: 7px;
        }

        .prepend-placeholder {
            position: absolute;
            top: 7px;
            right: 7px;
        }

        .p-l-20 {
            padding-left: 20px !important;
        }

        .p-r-20 {
            padding-right: 20px;
        }

        .card-container {
            max-width: 400px;
            margin: auto;
        }

        .card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
        }

        .card-title {
            color: #d96f00; /* orange */
            font-size: 0.85rem;
            font-weight: 600;
            margin: 0.5rem 0;
        }

        .card-value {
            color: #1d2d3c;
            font-size: 1.7rem;
            font-weight: 600;
            margin: 0.3rem 0 0.8rem;
        }

        .card-bar {
            position: absolute;
            bottom: 0px;
            width: 100%;
            left: 0px;
            height: 20px;
            border-radius: 0px 0px 10px 10px;
        }

        .green-bar {
            background-color: #1b823f;
        }

        .orange-bar {
            background-color: #f0821e;
        }

    </style>

</head>

<body>
    <div class="container" style="margin-bottom:50px;">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-12">
                        <h1 style="text-align: center;">Home Construction Loan Calculator</h1>
                    </div>
                </div>
                <div class="row" style="margin-top:30px">
                    <div class="col-md-4" style="border-right: 1px solid #ccc;">
                        <h6 style="text-align: center;">Property Information</h6>
                        <div class="form-group col-md-12">
                            <label>Property Action</label>
                            <div class="input-w-ph-c">
                                <select class="form-control" id="propertyAction">
                                    <option value="purchase" selected>Purchase</option>
                                    <option value="refinance">Refinance</option>
                                  </select>
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <label>Land Cost</label>
                            <div class="input-w-ph-c">
                                <div class="append-placeholder">$</div>
                                <input class="form-control p-l-20" type="text" id="landCost" fieldType="currency"
                                    value="100,000" placeholder="Land Cost">
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <label>Construction Cost</label>
                            <div class="input-w-ph-c">
                                <div class="append-placeholder">$</div>
                                <input class="form-control p-l-20" type="text" fieldType="currency" id="constructionCost"
                                    value="100,000" placeholder="Construction Cost">
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <label>Down Payment</label>
                            <div class="input-w-ph-c">
                                <div class="append-placeholder">$</div>
                                <input class="form-control p-l-20" type="text" fieldType="currency" id="downPayment"
                                    value="40,000" placeholder="Down Payment">
                            </div>
                        </div>

                        <h6 style="text-align: center;">Construction Information</h6>
                        <div class="form-group col-md-12">
                            <label>Construction Loan Rate</label>
                            <div class="input-w-ph-c">
                                <div class="prepend-placeholder">%</div>
                                <input class="form-control p-r-20" type="number" fieldType="precentage"
                                    id="constructionLoanRate" value="6.63" placeholder="Construction Loan Rate">
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <label>Construction Length</label>
                            <div class="input-w-ph-c">
                                <input class="form-control p-r-20" type="number" fieldType="number" id="constructionLength"
                                    value="12" placeholder="Construction Length">
                                <div class="prepend-placeholder">Months</div>
                            </div>
                        </div>

                        <h6 style="text-align: center;">Mortgage Information</h6>
                        <div class="form-group col-md-12">
                            <label>Mortgage Rate</label>
                            <div class="input-w-ph-c">
                                <input class="form-control p-r-20" type="number" fieldType="percentage"
                                    id="mortgageRate" value="5" placeholder="Mortgage Rate">
                                <div class="prepend-placeholder">%</div>
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <label>Mortgage Term</label>
                            <div class="input-w-ph-c">
                                <input class="form-control p-r-20" type="number" fieldType="number" id="mortgageTerm"
                                    value="30" placeholder="Mortgage Term">
                                <div class="prepend-placeholder">Months</div>
                            </div>
                        </div>

                        <div class="col-md-12" style="text-align: center; margin-bottom: 15px;">
                            <button onclick="calculate()"
                                style="padding:10px;margin:auto; border-radius:5px;background:#e44e56; border:1px solid #e44e56;color:#ffffff;font-size:18px;margin-top:20px;">Calculate</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-12" id="main-result-container" style="text-align: center">
                                <div>
                                    <h4>Mortgage Period Breakdown</h4>

                                </div>

                                <div class="card-container">
                                    <div class="card">
                                      <p class="card-title orange">Initial Mortgage Balance</p>
                                      <p class="card-value" id="out_1">$150,000</p>
                                      <div class="card-bar green-bar"></div>
                                    </div>
                                  
                                    <div class="card">
                                      <p class="card-title orange">Monthly Mortgage Payment</p>
                                      <p class="card-value" id="out_2">$805.23</p>
                                      <div class="card-bar orange-bar"></div>
                                    </div>
                                  </div>
                                  <!-- Chart -->
                                  <div>
                                    <canvas id="loanChart" width="800" height="400"></canvas>
                                  </div>
                                
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>


    //Common Script for all inputs (Convert to local string on input change)
    var all_inputs = document.getElementsByClassName("form-control");
    for (var i = 0; i < all_inputs.length; i++) {

        var single_input = all_inputs[i];
        single_input.oninput = function () {

            if (this.getAttribute('fieldType') == 'currency') {
                var value = this.value;
                value = value.replace(",", "");
                value = value.replace(",", "") * 1;
                if (isNaN(value)) {
                    alert('Invalid Input');
                    this.value = 0;
                } else {
                    this.value = (value).toLocaleString();
                }
            }
        }
    }

    //LOCALE STRING FUNCTION
    function locale_float(x) {
        return (x.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
    }

    function locale_integer(x) {
        return (x.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
    }

    // Convert formatted input back to float
    function parseFormattedNumber(value) {
        return parseFloat(value.replace(/,/g, "")) || 0;
    }

    function generateAmortizationData(principal, annualInterestRate, years) {
        const monthlyRate = annualInterestRate / 12 / 100;
        const totalMonths = years * 12;
        const monthlyPayment = principal * monthlyRate * Math.pow(1 + monthlyRate, totalMonths) / (Math.pow(1 + monthlyRate, totalMonths) - 1);

        let balance = principal;
        const labels = []; // numeric index (0 to 360), but we only show labels for full years
        const data = [];

        for (let month = 0; month <= totalMonths; month++) {
            if (month > 0) {
            const interest = balance * monthlyRate;
            const principalPaid = monthlyPayment - interest;
            balance -= principalPaid;
            }

            labels.push(month / 12); // Keep in years (e.g., 0, 0.08, 0.17..., 1, 1.08, ... 30)
            data.push(parseFloat(balance.toFixed(2)));
        }

        return { labels, data };
    }


    function calculateMonthlyPayment(principal, annualInterestRate, loanTermYears) {
        const monthlyRate = annualInterestRate / 12 / 100;
        const numberOfPayments = loanTermYears * 12;

        const numerator = monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments);
        const denominator = Math.pow(1 + monthlyRate, numberOfPayments) - 1;

        const monthlyPayment = principal * (numerator / denominator);
        return monthlyPayment.toFixed(2); // returns a string rounded to 2 decimal places
    }

    function calculate() {

        //Fetch values
        var landCost = parseFormattedNumber(document.getElementById('landCost').value);
        var constructionCost = parseFormattedNumber(document.getElementById('constructionCost').value);
        var downPayment = parseFormattedNumber(document.getElementById('downPayment').value);
        var constructionLoanRate = parseFormattedNumber(document.getElementById('constructionLoanRate').value);
        var constructionLength = parseFormattedNumber(document.getElementById('constructionLength').value);
        var mortgageRate = parseFormattedNumber(document.getElementById('mortgageRate').value);
        var mortgageTerm = parseFormattedNumber(document.getElementById('mortgageTerm').value);


        const totalCost = landCost + constructionCost;
        const mortgageBalance = totalCost - downPayment;
        const monthlyPayment = calculateMonthlyPayment(mortgageBalance, mortgageRate, mortgageTerm)

        document.getElementById('out_1').innerText = `$${locale_integer(mortgageBalance)}`;
        document.getElementById('out_2').innerText = `$${locale_integer(monthlyPayment)}`;

        const { labels, data } = generateAmortizationData(mortgageBalance, mortgageRate, mortgageTerm);

        //CHART PLOTTING
        const ctx = document.getElementById('loanChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                label: 'Remaining Balance',
                data: data,
                borderColor: '#e26a00',
                backgroundColor: 'transparent',
                pointRadius: 0,
                tension: 0.25
                }]
            },
            options: {
                responsive: true,
                plugins: {
                legend: { display: false },
                tooltip: { enabled: false } 
                // tooltip: {
                //         callbacks: {
                //             label: context => `$${context.parsed.y.toLocaleString(undefined, { maximumFractionDigits: 2 })}`
                //         }
                //     }
                },
                scales: {
                x: {
                    title: { display: true, text: 'Years Since Loan Start' },
                    ticks: {
                    callback: function(value, index, ticks) {
                        return Number(this.getLabelForValue(value)).toFixed(0); // Show full years only
                    },
                    maxTicksLimit: 31 // From 0 to 30
                    }
                },
                y: {
                    title: { display: true, text: 'Loan Amount ($)' },
                    beginAtZero: true,
                    ticks: {
                    callback: value => `$${value / 1000}k`
                    }
                }
                }
            }
        });

        }

    //call the calculate on page load
    calculate();
</script>


</html>
